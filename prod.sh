#!/bin/bash

# Script para gerenciar o ambiente de produ√ß√£o do Stockbit

set -e

# Escolher qual compose usar (caddy ou nginx direto)
if [ -f "docker-compose.prod-caddy.yml" ] && [ -z "$USE_NGINX" ]; then
    PROD_COMPOSE="docker-compose -f docker-compose.prod-caddy.yml"
    echo "Usando configura√ß√£o com Caddy"
else
    PROD_COMPOSE="docker-compose -f docker-compose.prod.yml"
    echo "Usando configura√ß√£o com Nginx direto"
fi

case "$1" in
    start)
        echo "üöÄ Iniciando servi√ßos de produ√ß√£o..."
        $PROD_COMPOSE up -d
        echo "‚úÖ Servi√ßos iniciados com sucesso!"
        ;;
    
    stop)
        echo "üõë Parando servi√ßos de produ√ß√£o..."
        $PROD_COMPOSE stop
        echo "‚úÖ Servi√ßos parados!"
        ;;
    
    restart)
        echo "üîÑ Reiniciando servi√ßos de produ√ß√£o..."
        $PROD_COMPOSE restart
        echo "‚úÖ Servi√ßos reiniciados!"
        ;;
    
    build)
        echo "üî® Construindo imagens de produ√ß√£o..."
        $PROD_COMPOSE build
        echo "‚úÖ Imagens constru√≠das!"
        ;;
    
    build-no-cache)
        echo "üî® Construindo imagens de produ√ß√£o (sem cache)..."
        $PROD_COMPOSE build --no-cache
        echo "‚úÖ Imagens constru√≠das!"
        ;;
    
    logs)
        $PROD_COMPOSE logs -f ${2:-}
        ;;
    
    ps)
        $PROD_COMPOSE ps
        ;;
    
    down)
        echo "‚ö†Ô∏è  Removendo containers de produ√ß√£o..."
        $PROD_COMPOSE down
        echo "‚úÖ Containers removidos!"
        ;;
    
    down-volumes)
        echo "‚ö†Ô∏è  Removendo containers e volumes de produ√ß√£o..."
        $PROD_COMPOSE down -v
        echo "‚úÖ Containers e volumes removidos!"
        ;;
    
    shell-backend)
        $PROD_COMPOSE exec backend sh
        ;;
    
    shell-db)
        $PROD_COMPOSE exec db psql -U stockbit_user stockbit_db
        ;;
    
    createsuperuser)
        echo "üë§ Criando superusu√°rio..."
        $PROD_COMPOSE exec backend python manage.py createsuperuser
        ;;
    
    migrate)
        echo "üóÑÔ∏è  Aplicando migra√ß√µes..."
        $PROD_COMPOSE exec backend python manage.py migrate
        ;;
    
    backup)
        BACKUP_FILE="backup_$(date +%Y%m%d_%H%M%S).sql"
        echo "üíæ Fazendo backup do banco de dados..."
        $PROD_COMPOSE exec -T db pg_dump -U stockbit_user stockbit_db > $BACKUP_FILE
        echo "‚úÖ Backup criado: $BACKUP_FILE"
        ;;
    
    update)
        echo "üîÑ Atualizando sistema de produ√ß√£o..."
        git pull
        $PROD_COMPOSE build
        $PROD_COMPOSE up -d
        echo "‚úÖ Sistema atualizado!"
        ;;
    
    *)
        echo "üì¶ Stockbit - Gerencial Sistema de Produ√ß√£o"
        echo ""
        echo "Uso: ./prod.sh [comando]"
        echo ""
        echo "Comandos dispon√≠veis:"
        echo "  start              Iniciar servi√ßos"
        echo "  stop               Parar servi√ßos"
        echo "  restart            Reiniciar servi√ßos"
        echo "  build              Construir imagens"
        echo "  build-no-cache     Construir imagens (sem cache)"
        echo "  logs [servi√ßo]     Ver logs (ex: logs backend)"
        echo "  ps                 Ver status dos servi√ßos"
        echo "  down               Remover containers"
        echo "  down-volumes       Remover containers e volumes"
        echo "  shell-backend      Acessar shell do backend"
        echo "  shell-db           Acessar shell do banco de dados"
        echo "  createsuperuser    Criar usu√°rio administrador"
        echo "  migrate            Aplicar migra√ß√µes"
        echo "  backup             Fazer backup do banco de dados"
        echo "  update             Atualizar sistema (git pull + build)"
        echo ""
        exit 1
        ;;
esac

