{% extends 'base.html' %}

{% block page_title %}Entrada via XML{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-8 mx-auto">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="bi bi-file-earmark-code"></i> Entrada via XML de NF-e</h5>
                <a href="{% url 'estoque:entrada_manual' %}" class="btn btn-sm btn-outline-primary">
                    <i class="bi bi-pencil"></i> Entrada Manual
                </a>
            </div>
            <div class="card-body">
                {% if messages %}
                    {% for message in messages %}
                        <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                            {{ message }}
                            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                        </div>
                    {% endfor %}
                {% endif %}
                
                <div class="alert alert-info">
                    <i class="bi bi-info-circle"></i> 
                    Envie o arquivo XML da Nota Fiscal Eletrônica. O sistema irá extrair automaticamente 
                    os produtos e permitir vinculá-los ao cadastro existente ou criar novos produtos.
                </div>
                
                {% if form.non_field_errors %}
                    <div class="alert alert-danger">
                        {% for error in form.non_field_errors %}
                            <div>{{ error }}</div>
                        {% endfor %}
                    </div>
                {% endif %}
                
                <form method="post" enctype="multipart/form-data">
                    {% csrf_token %}
                    
                    <div class="mb-3">
                        <label for="{{ form.arquivo_xml.id_for_label }}" class="form-label">{{ form.arquivo_xml.label }}</label>
                        <div class="file-input-wrapper position-relative">
                            {{ form.arquivo_xml }}
                            <div id="file-name-display" class="text-muted small mt-2" style="display: none;">
                                <i class="bi bi-file-earmark-code"></i> <span id="file-name-text"></span>
                            </div>
                        </div>
                        {% if form.arquivo_xml.errors %}
                            <div class="text-danger small mt-1">{{ form.arquivo_xml.errors }}</div>
                        {% endif %}
                        <small class="form-text text-muted">Selecione o arquivo XML da NF-e (.xml)</small>
                    </div>
                    
                    <style>
                        .file-input-wrapper input[type="file"] {
                            display: block !important;
                            width: 100% !important;
                            padding: 0.5rem !important;
                            font-size: 1rem !important;
                            line-height: 1.5 !important;
                            color: #212529 !important;
                            background-color: #fff !important;
                            border: 1px solid #ced4da !important;
                            border-radius: 0.375rem !important;
                            cursor: pointer !important;
                            position: relative !important;
                            z-index: 10 !important;
                            pointer-events: auto !important;
                            opacity: 1 !important;
                            visibility: visible !important;
                        }
                        
                        .file-input-wrapper input[type="file"]:hover {
                            border-color: #86b7fe !important;
                        }
                        
                        .file-input-wrapper input[type="file"]:focus {
                            border-color: #86b7fe !important;
                            outline: 0 !important;
                            box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25) !important;
                        }
                        
                        .file-input-wrapper input[type="file"]::file-selector-button {
                            padding: 0.375rem 0.75rem;
                            margin-right: 0.75rem;
                            color: #fff;
                            background-color: #0d6efd;
                            border: 0;
                            border-radius: 0.375rem;
                            cursor: pointer;
                            font-weight: 500;
                        }
                        
                        .file-input-wrapper input[type="file"]::file-selector-button:hover {
                            background-color: #0b5ed7;
                        }
                    </style>
                    
                    <script>
                        document.addEventListener('DOMContentLoaded', function() {
                            const fileInput = document.getElementById('{{ form.arquivo_xml.id_for_label }}');
                            const fileNameDisplay = document.getElementById('file-name-display');
                            const fileNameText = document.getElementById('file-name-text');
                            
                            if (fileInput) {
                                // Garante que o input esteja visível e clicável
                                fileInput.style.display = 'block';
                                fileInput.style.visibility = 'visible';
                                fileInput.style.opacity = '1';
                                fileInput.style.pointerEvents = 'auto';
                                fileInput.style.position = 'relative';
                                fileInput.style.zIndex = '10';
                                
                                // Mostra o nome do arquivo quando selecionado
                                fileInput.addEventListener('change', function(e) {
                                    if (this.files && this.files.length > 0) {
                                        fileNameText.textContent = this.files[0].name;
                                        fileNameDisplay.style.display = 'block';
                                    } else {
                                        fileNameDisplay.style.display = 'none';
                                    }
                                });
                                
                                // Permite clicar no label para abrir o seletor
                                const label = document.querySelector('label[for="{{ form.arquivo_xml.id_for_label }}"]');
                                if (label) {
                                    label.style.cursor = 'pointer';
                                    label.addEventListener('click', function(e) {
                                        e.preventDefault();
                                        fileInput.click();
                                    });
                                }
                            }
                        });
                    </script>
                    
                    <div class="mb-3">
                        <label for="{{ form.fornecedor.id_for_label }}" class="form-label">{{ form.fornecedor.label }}</label>
                        {{ form.fornecedor }}
                        <small class="form-text text-muted">Opcional - Selecione o fornecedor da nota</small>
                        {% if form.fornecedor.errors %}
                            <div class="text-danger small">{{ form.fornecedor.errors }}</div>
                        {% endif %}
                    </div>
                    
                    <button type="submit" class="btn btn-primary" id="btn-processar">
                        <i class="bi bi-upload"></i> <span id="btn-text">Processar XML</span>
                        <span id="btn-loading" class="spinner-border spinner-border-sm ms-2 d-none" role="status" aria-hidden="true"></span>
                    </button>
                    <a href="{% url 'estoque:index' %}" class="btn btn-secondary">
                        <i class="bi bi-x-circle"></i> Cancelar
                    </a>
                </form>
                
                <script>
                    // Loading indicator durante processamento
                    document.querySelector('form').addEventListener('submit', function(e) {
                        const btn = document.getElementById('btn-processar');
                        const btnText = document.getElementById('btn-text');
                        const btnLoading = document.getElementById('btn-loading');
                        
                        if (btn && btnText && btnLoading) {
                            btn.disabled = true;
                            btnText.textContent = 'Processando...';
                            btnLoading.classList.remove('d-none');
                        }
                    });
                </script>
            </div>
        </div>
    </div>
</div>
{% endblock %}

